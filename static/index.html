<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RemoteBox Wi-Fi Manager</title>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-gray-800 p-4 font-sans">

  <div id="app" class="max-w-xl mx-auto">

    <!-- Current Wi-Fi Status -->
    <div class="mb-6">
      <h2 class="text-lg font-semibold mb-2">Current Wi-Fi Status</h2>
      <div v-if="wifiStatus.connected">
        <p class="mb-1"><strong>Status:</strong> Connected</p>
        <p>
          <strong>SSID:</strong> {{ wifiStatus.ssid }}<br />
          <strong>IP:</strong> {{ wifiStatus.ip }}
        </p>
      </div>
      <div v-else>
        <p><strong>Status:</strong> Not connected</p>
      </div>
    </div>

    <!-- Wi-Fi Network List -->
    <div v-if="!selectedSsid">
      <h2 class="text-lg font-semibold mb-3">Available Networks</h2>
      <ul>
        <li
          v-for="ssid in wifiList"
          :key="ssid"
          @click="selectSsid(ssid)"
          class="wifi-entry px-4 py-3 mb-2 rounded border border-gray-300 shadow-sm hover:bg-gray-100 cursor-pointer transition disabled:opacity-50"
          :class="{ 'opacity-50 pointer-events-none': ssid === wifiStatus.ssid }"
        >
          {{ ssid }}
        </li>
      </ul>
    </div>

    <!-- Connect Form -->
    <div v-else class="mt-6">
      <h2 class="text-md font-medium mb-3">
        Connect to <b>{{ selectedSsid }}</b>
      </h2>
      <form @submit.prevent="connectWifi" class="space-y-3">
        <div class="w-full">
          <input
            type="text"
            v-model="wifiPassword"
            class="w-full flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400"
            placeholder="Password"
            required
          />
        </div>

        <div v-if="connectError" class="text-red-600 text-sm">
          {{ connectError }}
        </div>

        <div class="flex justify-center items-center">
          <div class="w-[30%] flex justify-center">
            <span
              class="text-blue-600 underline cursor-pointer text-sm"
              @click="cancelConnect"
            >
              Cancel
            </span>
          </div>
          <div class="w-[70%]">
            <button
              type="submit"
              :disabled="connecting"
              class="w-full px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded transition disabled:opacity-50"
            >
              {{ connecting ? "Connecting..." : "Connect" }}
            </button>
          </div>
        </div>
      </form>
    </div>

  </div>

  <!-- Vue Logic -->
  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          wifiStatus: { connected: false, ssid: null, ip: null },
          wifiList: [],
          selectedSsid: null,
          wifiPassword: "",
          connecting: false,
          connectError: null,
        };
      },
      methods: {
        fetchStatus() {
          fetch("/wifi_status")
            .then((r) => r.json())
            .then((data) => {
              this.wifiStatus = data;
              this.fetchWifiList();
            });
        },
        fetchWifiList() {
          fetch("/wifi_list")
            .then((r) => r.json())
            .then((data) => {
              this.wifiList = data.filter(
                (ssid) => ssid !== this.wifiStatus.ssid
              );
            });
        },
        selectSsid(ssid) {
          this.selectedSsid = ssid;
          this.connectError = null;
        },
        cancelConnect() {
          this.selectedSsid = null;
          this.wifiPassword = "";
          this.connectError = null;
        },
        connectWifi() {
          this.connecting = true;
          this.connectError = null;

          fetch("/connect_wifi", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: new URLSearchParams({
              ssid: this.selectedSsid,
              password: this.wifiPassword,
            }),
          })
            .then((response) => {
              if (!response.ok) {
                return response.text().then((msg) => {
                  throw new Error(msg || "Connection failed");
                });
              }
              return new Promise((resolve) => setTimeout(resolve, 3000));
            })
            .then(() => {
              this.connecting = false;
              this.selectedSsid = null;
              this.wifiPassword = "";
              this.fetchStatus();
            })
            .catch((error) => {
              this.connecting = false;
              this.connectError = error.message || "Connection failed";
            });
        },
      },
      mounted() {
        this.fetchStatus();
      },
    }).mount("#app");
  </script>

</body>
</html>