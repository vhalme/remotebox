<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RemoteBox Wi-Fi Manager</title>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <!-- Bootstrap 5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      padding: 1rem;
      font-family: sans-serif;
    }

    .wifi-entry {
      cursor: pointer;
      transition: background 0.2s ease;
      user-select: none;
    }

    .wifi-entry:hover {
      background-color: #f8f9fa;
    }

    .wifi-entry.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    .form-control,
    .btn {
      font-size: 1rem;
    }

    @media (max-width: 576px) {
      .input-group {
        flex-direction: column;
        align-items: stretch;
      }

      .input-group .form-control,
      .input-group .btn {
        width: 100%;
        margin-bottom: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <div id="app" class="container">

    <!-- Current Wi-Fi Status -->
    <div class="mb-4">
      <h2 class="h4">Current Wi-Fi Status</h2>
      <div v-if="wifiStatus.connected">
        <p class="mb-1"><strong>Status:</strong> Connected</p>
        <p><strong>SSID:</strong> {{ wifiStatus.ssid }}<br /><strong>IP:</strong> {{ wifiStatus.ip }}</p>
      </div>
      <div v-else>
        <p><strong>Status:</strong> Not connected</p>
      </div>
    </div>

    <!-- Wi-Fi Network List -->
    <div v-if="!selectedSsid">
      <h2 class="h4">Available Networks</h2>
      <ul class="list-group">
        <li
          v-for="ssid in wifiList"
          :key="ssid"
          class="list-group-item wifi-entry d-flex justify-content-between align-items-center"
          @click="selectSsid(ssid)"
          :class="{ disabled: ssid === wifiStatus.ssid }"
        >
          {{ ssid }}
        </li>
      </ul>
    </div>

    <!-- Connect Form -->
    <div v-else class="mt-4">
      <h2 class="h5 mb-3">Connect to {{ selectedSsid }}</h2>
      <form @submit.prevent="connectWifi">
        <div class="input-group mb-3 flex-column flex-sm-row">
          <input
            type="password"
            v-model="wifiPassword"
            class="form-control"
            placeholder="Password (plain)"
            required
          />
          <button
            class="btn btn-primary"
            type="submit"
            :disabled="connecting"
          >
            {{ connecting ? "Connecting..." : "Connect" }}
          </button>
        </div>
        <button
          class="btn btn-secondary w-100 w-sm-auto"
          type="button"
          @click="cancelConnect"
        >
          Back to list
        </button>
      </form>
    </div>
  </div>

  <!-- Vue Logic -->
  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          wifiStatus: { connected: false, ssid: null, ip: null },
          wifiList: [],
          selectedSsid: null,
          wifiPassword: "",
          connecting: false,
        };
      },
      methods: {
        fetchStatus() {
          fetch("/wifi_status")
            .then((r) => r.json())
            .then((data) => {
              this.wifiStatus = data;
              this.fetchWifiList();
            });
        },
        fetchWifiList() {
          fetch("/wifi_list")
            .then((r) => r.json())
            .then((data) => {
              this.wifiList = data.filter(
                (ssid) => ssid !== this.wifiStatus.ssid
              );
            });
        },
        selectSsid(ssid) {
          this.selectedSsid = ssid;
        },
        cancelConnect() {
          this.selectedSsid = null;
          this.wifiPassword = "";
        },
        connectWifi() {
          this.connecting = true;
          fetch("/connect_wifi", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: new URLSearchParams({
              ssid: this.selectedSsid,
              password: this.wifiPassword,
            }),
          })
            .then(() => {
              setTimeout(() => {
                this.connecting = false;
                this.selectedSsid = null;
                this.wifiPassword = "";
                this.fetchStatus();
              }, 3000);
            })
            .catch(() => {
              this.connecting = false;
            });
        },
      },
      mounted() {
        this.fetchStatus();
      },
    }).mount("#app");
  </script>
</body>
</html>
